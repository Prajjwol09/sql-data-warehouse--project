/*
Script purpose: This script acts as a "Data Cleaning Station" that takes raw, messy data from various source files (the bronze layer) and standardizes it before it's used for analysis.
*/

-- cleaning and loading the data into the silver layer 

-- creating store procedure		
		-- duration to load each tables
		-- duration to load the whole silver layer
		-- error handling using try-catch
		-- error messages

create or alter procedure silver.load_silver as 
begin
	declare @start_time datetime, @end_time datetime, @batch_start_time datetime, @batch_end_time datetime;
	begin try
			set @batch_start_time = getdate();
			print('---------------------------------------------------');
			print ('Loading CRM_CUSTOMER_INFO table');
			print('---------------------------------------------------');
			set @start_time = getdate();
			-- For "CRM_CUSTOMER_INFO"

			-- truncating the table 
			truncate table silver.crm_customer_info;

			-- inserting the data into "crm_customer_info" table of silver layer
			insert into silver.crm_customer_info(cst_id, cst_key, cst_firstname, cst_lastname, cst_marital_status, cst_gndr, cst_create_Date)
			select 
				cst_id,
				cst_key,
				trim(cst_firstname) as cst_firstname,
				trim(cst_lastname) as cst_lastname,
				case 
					when upper(trim(cst_marital_status)) = 'S' then 'Single'
					when upper(trim(cst_marital_status)) = 'M' then 'Married'
					else 'Unknown'
				end as cst_marital_status,
				case 
					when upper(trim(cst_gndr)) = 'F' then 'Female'
					when upper(trim(cst_gndr)) = 'M' then 'Male'
					else 'Unknown'
				end as cst_gndr,
				cst_create_date
			from 
			(
			select 
				*,
				row_number() over(partition by cst_id order by cst_create_Date desc) as last_flag 
			from bronze.crm_customer_info
			where cst_id is not null
			) as sub_query;
			set @end_time = getdate();
			print('The time taken to load the crm_customer_info table is: ') + cast(datediff(second, @start_time, @end_time) as nvarchar) + ' seconds';
			print('----------------------------------------------------');


			print('---------------------------------------------------');
			print ('Loading CRM_PRODUCT_INFO table');
			print('---------------------------------------------------');
			set @start_time = getdate();
			-- FOR "CRM_PRODUCT_INFO"

			-- truncating the table 
			truncate table silver.crm_product_info;

			-- inserting the data into "crm_product_info" table of silver layer 
			insert into silver.crm_product_info(prd_id,category_id,prod_key,prd_nm,prd_cost,prd_line,prd_Start_dt,prd_end_dt)
			select	
				prd_id,
				replace(substring(prd_key, 1, 5), '-','_') as category_id,      -- derived column
				SUBSTRING(prd_key, 7, len(prd_key)) as prod_key,                -- derived column
				prd_nm,
				coalesce(prd_cost, 0) as prd_cost,
				case 
					when upper(trim(prd_line)) = 'M' then 'Mountain'
					when upper(trim(prd_line)) = 'R' then 'Road'
					when upper(trim(prd_line)) = 'S' then 'Other Sales'
					when upper(trim(prd_line)) = 'T' then 'Touring'
					else 'Unknown'
				end as prd_line,
				cast(prd_start_dt as date) as prd_start_dt,
				cast(lead(prd_start_dt) over (partition by prd_key order by prd_start_dt)-1 as date)as prd_end_dt
			from bronze.crm_product_info;


			-- creating table because there are addition of columns and change in data type of the columns in silver.crm_product_info
			if object_id ('silver.crm_product_info' , 'U') is not null
			drop table silver.crm_product_info;
			create table silver.crm_product_info 
			(
				prd_id int,
				category_id  nvarchar(50),
				prod_key  nvarchar(50),
				prd_nm nvarchar(50),
				prd_cost int,
				prd_line nvarchar(50),
				prd_Start_dt date,
				prd_end_dt date,
				dwh_createdate datetime2 default getdate()
			);
			set @end_time = getdate();
			print('The time taken to load the crm_product_info table is: ') + cast(datediff(second, @start_time, @end_time) as nvarchar) + ' seconds';
			print('----------------------------------------------------');


	
			print('---------------------------------------------------');
			print ('Loading CRM_sales_Details table');
			print('---------------------------------------------------');
			set @start_time = getdate();
			-- For "CRM_SALES_DETAILS" table

			-- truncating the table 
			truncate table silver.crm_sales_details;

			-- inserting the data into "crm_sales_details " table of silver layer 
			insert into silver.crm_sales_Details
			(sls_ord_num, sls_prd_key, sls_cust_id, sls_order_dt, sls_ship_dt, sls_due_dt, sls_sales, sls_quantity, sls_price)
			select 
				sls_ord_num,
				sls_prd_key,
				sls_cust_id,
				case 
					when sls_order_dt = 0 or len(sls_order_dt) != 8 then null
					else cast(cast(sls_order_dt as varchar) as date)   -- we cannot change the int directly to date data type so first changing to varchar is essential.
				end as sls_order_dt,
				case 
					when sls_ship_dt = 0 or len(sls_ship_dt) != 8 then null
					else cast(cast(sls_ship_dt as varchar) as date)
				end as sls_ship_dt,
				case 
					when sls_due_dt = 0 or len(sls_due_dt) != 8 then null
					else cast(cast(sls_due_dt as varchar) as date)
				end as sls_due_dt,
				case 
					when sls_sales is null or sls_Sales <= 0 or sls_Sales != sls_quantity * abs(sls_price) then sls_quantity * abs(sls_price)
					else sls_Sales
				end as sls_sales,
				sls_quantity,
				case 
					when sls_price is null or sls_price <= 0 then sls_sales/nullif(sls_quantity,0)
					else sls_price
				end as sls_price
			from bronze.crm_Sales_Details;


			-- creating table because there are addition of columns and change in data type of the columns in silver.crm_product_info
			if object_id ('silver.crm_sales_Details' , 'U') is not null
			drop table silver.crm_sales_Details;
			create table silver.crm_sales_Details
			(
				sls_ord_num nvarchar(50),
				sls_prd_key nvarchar(50),
				sls_cust_id int,
				sls_order_dt date,
				sls_ship_dt date, 
				sls_due_dt date,
				sls_sales int,
				sls_quantity int,
				sls_price int,
				dwh_createdate datetime2 default getdate()
			);
			print('The time taken to load the crm_sales_Details table is: ') + cast(datediff(second, @start_time, @end_time) as nvarchar) + ' seconds';
			print('----------------------------------------------------');


			print('---------------------------------------------------');
			print ('Loading erp_cust_az12 table');
			print('---------------------------------------------------');
			set @start_time = getdate();
			-- for "erp_cust_az12" table 

			-- truncating the table 
			truncate table silver.erp_cust_az12;

			-- inserting the data into "erp_cust_az12 " table of silver layer 
			insert into silver.erp_cust_az12 (cid, bdate, gen)
			select 
				case
					when cid like 'NAS%' then substring(cid, 4, len(cid)) 
					else cid
				end as cid,
				case 
					when bdate > getdate() then null
					else bdate
				end as bdate,
				case 
					when upper(trim(gen)) in ('F', 'FEMALE') THEN 'Female'
					when upper(trim(gen)) in ('M', 'MALE') THEN 'Male'
						 else 'Unknown'
				end as gen
			from bronze.erp_cust_az12;
			set @end_time = getdate();
			print('The time taken to load the erp_cust_az12 table is: ') + cast(datediff(second, @start_time, @end_time) as nvarchar) + ' seconds';
			print('----------------------------------------------------');


			print('---------------------------------------------------');
			print ('Loading CRM_CUSTOMER_INFO table');
			print('---------------------------------------------------');
			set @start_time = getdate();
			-- for "erp_loc_a101" table 

			-- truncating the table 
			truncate table silver.erp_loc_a101;

			-- inserting the data into "erp_cust_az12 " table of silver layer 
			insert into silver.erp_loc_a101(cid, cntry)
			select  
				replace(cid, '-', '') as cid,
				case
					when trim(cntry) = 'DE' then 'Germany'
					when trim(cntry) IN ('US', 'USA') then 'United States'
					when trim(cntry) is null or cntry = ' ' then 'Unknown'
					else cntry
				end as cntry
			from bronze.erp_loc_a101;
			set @end_time = getdate();
			print('The time taken to load the erp_loc_a101 table is: ') + cast(datediff(second, @start_time, @end_time) as nvarchar) + ' seconds';
			print('----------------------------------------------------');


			print('---------------------------------------------------');
			print ('Loading erp_px_cat_g1v2 table');
			print('---------------------------------------------------');
			set @start_time = getdate();
			-- for "erp_px_cat_g1v2" table

			-- truncating the table 
			truncate table silver.erp_px_cat_g1v2;

			-- inserting the data into "erp_px_cat_g1v2" table of silver layer 
			insert into silver.erp_px_cat_g1v2(id, cat, subcat, maintenance)
			select 
				id,
				cat,
				subcat,
				maintenance
			from bronze.erp_px_cat_g1v2;
			set @end_time = getdate();
			print('The time taken to load the erp_px_cat_g1v2 table is: ') + cast(datediff(second, @start_time, @end_time) as nvarchar) + ' seconds';
			print('----------------------------------------------------');

			set @batch_end_time = getdate();
			print ('The time taken to load the whole silver layer is: ') + cast(datediff(second, @batch_start_time, @batch_end_time) as nvarchar) + ' seconds';
	end try
		begin catch
				print 'Error occurred while loading bronze layer'
				print 'error message: ' + error_message();
				print 'error number: ' + cast(error_number() as nvarchar);
				print 'error state: ' + cast(error_state() as nvarchar);
		end catch
end

-- executing stored procedure
exec silver.load_silver
